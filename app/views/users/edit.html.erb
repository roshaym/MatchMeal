<% if @user.present? %>
  <%= turbo_stream_from "profile_#{@user.id}" %>

  <div class="container">
    <h1 class="text-white">Edit Your Profile</h1>
    <!-- Profile Card for Edit Form -->
    <div class="card mt-4">
      <div class="card-body">
        <!-- Profile Picture and Username Section -->
        <div class="d-flex flex-column align-items-center mb-4">
          <!-- Check if user has a profile picture -->
          <div class="profile-pic-container mb-3">
            <% if @user.profile_picture.attached? %>
              <%= image_tag @user.profile_picture.url, alt: "Profile Picture", class: "rounded-circle profile-pic", width: "100", height: "100" %>
            <% else %>
              <!-- Use placeholder URL if no profile picture is attached -->
              <%= image_tag "https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png?20150327203541", alt: "Default Avatar", class: "rounded-circle profile-pic", width: "100" %>
            <% end %>
          </div>
        </div>

        <!-- Form Starts Here -->
        <%= form_with model: @user, url: user_path(@user), method: :patch, local: false do |form| %>
          <!-- First Name -->
          <div class="form-group">
            <%= form.label :first_name, class: 'text-primary' %>
            <%= form.text_field :first_name, class: 'form-control' %>
          </div>

          <!-- Last Name -->
          <div class="form-group">
            <%= form.label :last_name, class: 'text-primary' %>
            <%= form.text_field :last_name, class: 'form-control' %>
          </div>

          <!-- Email -->
          <div class="form-group">
            <%= form.label :email, class: 'text-primary' %>
            <%= form.email_field :email, class: 'form-control' %>
          </div>

          <!-- Profile Picture -->
          <div class="form-group">
            <%= form.label :profile_picture, class: 'text-primary' %>

            <!-- Profile Picture Upload -->
            <div class="custom-file mt-4 mb-4">
              <%= form.file_field :profile_picture, 
                  class: 'custom-file-input d-none', 
                  id: 'profile_picture_input', 
                  accept: 'image/*', 
                  data: { action: 'change->profile#preview' } %>
              <label for="profile_picture_input" class="btn btn-outline-primary rounded-pill text-white">
                Upload New Picture
              </label>
            </div>

            <!-- Image Preview Container -->
            <div id="avatar_preview_container" class="text-center">
              <img id="avatar_preview" 
                   style="max-width: 200px; max-height: 200px; display: none;" 
                   alt="Image Preview" 
                   class="img-fluid rounded" />
            </div>
          </div>

          <!-- Password fields only if the user wants to change the password -->
          <div class="form-group mt-4">
            <%= form.label :password, 'New Password', class: 'text-primary' %>
            <%= form.password_field :password, class: 'form-control' %>
          </div>

          <div class="form-group">
            <%= form.label :password_confirmation, 'Confirm New Password', class: 'text-primary' %>
            <%= form.password_field :password_confirmation, class: 'form-control' %>
          </div>

          <!-- Submit Button with more spacing -->
          <div class="form-group mt-4">
            <%= form.submit 'Update Profile', class: 'btn btn-primary btn-lg rounded-pill shadow-sm mb-3' %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% else %>
  <!-- Message when user is not found or logged in -->
  <div class="alert alert-danger">
    User not found or you are not logged in. Please log in again.
  </div>
<% end %>

<div id="error_message"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const profilePictureInput = document.getElementById('profile_picture_input');
  const avatarPreview = document.getElementById('avatar_preview');

  profilePictureInput.addEventListener('change', function(event) {
    const input = event.target;
    
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        avatarPreview.src = e.target.result;
        avatarPreview.style.display = 'block';
      }
      
      reader.readAsDataURL(input.files[0]);
    } else {
      avatarPreview.style.display = 'none';
    }
  });
});
</script>
