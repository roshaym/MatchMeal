<div class="container my-5" data-controller="ingredient-detection">
  <%= render 'shared/header', title: 'Detect Ingredients' %>

  <%= form_with(url: process_image_recipes_path, method: :post, multipart: true, class: "needs-validation") do |form| %>
    <div class="form-group mb-4">
      <%= form.label :image, "Upload or Take a Picture", class: "form-label" %>
      <%= form.file_field :image,
            accept: "image/*",
            class: "form-control-file",
            data: {
              'ingredient-detection-target': 'imageUpload',
              action: 'change->ingredient-detection#imageSelected'
            } %>
      <small class="form-text text-muted">You can upload an image or take a picture using your device's camera.</small>
    </div>

    <div class="d-flex justify-content-center">
      <%= form.submit "Detect Ingredients",
            class: 'btn btn-primary btn-lg rounded-pill shadow-sm mb-3',
            data: {
              'ingredient-detection-target': 'detectButton'
            },
            disabled: true %>
    </div>
  <% end %>

  <% if session[:detected_ingredients].present? %>
    <%= form_with(url: recipes_path, method: :get, local: true) do |form| %>
      <div class="mt-5">
        <h2 class="text-center">Detected Ingredients</h2>
        <div class="list-group mt-3">
          <% session[:detected_ingredients].split(',').each_with_index do |ingredient, index| %>
            <label class="list-group-item d-flex align-items-center">
              <%= check_box_tag 'selected_ingredients[]', ingredient.strip, true, 
                    id: "ingredient_#{index}", 
                    class: "form-check-input me-3",
                    data: {
                      'ingredient-detection-target': 'ingredientCheckbox'
                    } %>
              <span class="text-capitalize flex-grow-1">
                <%= ingredient.strip %>
              </span>
            </label>
          <% end %>
        </div>
      </div>

      <div class="d-flex justify-content-center my-4">
        <%= form.submit "Generate Recipes", 
              class: "btn btn-primary btn-lg rounded-pill shadow-sm mb-3",
              data: {
                'ingredient-detection-target': 'generateButton'
              } %>
      </div>
    <% end %>
  <% end %>
</div>
